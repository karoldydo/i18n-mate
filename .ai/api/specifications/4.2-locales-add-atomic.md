# 4.2 Add Locale to Project (Atomic - Recommended)

**Endpoint:** `POST /rest/v1/rpc/create_project_locale_atomic`
**Description:** Add new locale to project with atomic fan-out verification. **Recommended approach with built-in error handling and verification.**
**Authentication:** Required

**Request Body:**

```json
{
  "p_label": "Polski",
  "p_locale": "pl",
  "p_project_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Field Validation:**

- `p_project_id` (required, UUID) - Project ID
- `p_locale` (required, string) - BCP-47 locale code (ll or ll-CC format, normalized automatically)
- `p_label` (required, string) - Human-readable locale label (max 64 characters, trimmed)

**Success Response (201 Created):**

```json
{
  "created_at": "2025-01-15T10:05:00Z",
  "id": "uuid",
  "label": "Polski",
  "locale": "pl",
  "project_id": "550e8400-e29b-41d4-a716-446655440000",
  "updated_at": "2025-01-15T10:05:00Z"
}
```

**Error Responses:**

- `400 Bad Request` - Invalid locale format (must be ll or ll-CC)
- `400 Bad Request` - Project not found or access denied
- `409 Conflict` - Locale already exists for project
- `500 Internal Server Error` - Fan-out verification failed

**Enhanced Error Responses (Atomic-specific):**

**Fan-out Verification Failed:**

```json
{
  "data": null,
  "error": {
    "code": 500,
    "details": {
      "error_code": "FANOUT_VERIFICATION_FAILED"
    },
    "message": "Failed to initialize translations for new locale"
  }
}
```

**Fan-out Incomplete:**

```json
{
  "data": null,
  "error": {
    "code": 500,
    "details": {
      "actual": 147,
      "error_code": "FANOUT_INCOMPLETE",
      "expected": 150
    },
    "message": "Incomplete translation initialization"
  }
}
```

**Validation Errors:**

**Invalid Locale Format:**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "locale_format",
      "field": "p_locale"
    },
    "message": "Locale must be in BCP-47 format (e.g., \"en\" or \"en-US\")"
  }
}
```

**Label Too Long:**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "max_length",
      "field": "p_label"
    },
    "message": "Label must be at most 64 characters"
  }
}
```

**Business Logic:**

- Trigger `normalize_project_locale_insert_trigger` normalizes to lowercase-language / UPPERCASE-REGION
- Trigger `fanout_translation_locale_insert_trigger` creates translation records:
  - For all existing keys in project
  - With `value = NULL` (missing)
  - With `updated_source = 'user'`
- Built-in verification ensures all translation records are created successfully
- Atomic operation (all-or-nothing) prevents partial state
- Enhanced retry logic for transient failures
- Automatic rollback on any step failure
- Emit `language_added` telemetry event with `locale_count` in properties

**Advantages of Atomic Approach:**

- Built-in fan-out verification ensures all translation records are created
- Better error reporting with specific error codes for troubleshooting
- Atomic operation (all-or-nothing) prevents partial state
- Automatic telemetry event emission for analytics
- Enhanced retry logic for transient failures
- Rollback on any step failure

**Side Effects:**

- **Telemetry Event Emitted:** `language_added`
  - Properties: `{ locale: "pl", locale_count: 2 }`
  - Used for KPI tracking: projects with 2+ languages after 7 days

**Example Telemetry Event:**

```json
{
  "created_at": "2025-01-15T10:05:00Z",
  "event_name": "language_added",
  "project_id": "550e8400-e29b-41d4-a716-446655440000",
  "properties": {
    "locale": "pl",
    "locale_count": 2
  }
}
```

**Performance Impact:**

- For projects with many keys (>100), fan-out may take 2-5 seconds
- Built-in verification adds minimal overhead (~100ms)
- Atomic operation ensures data consistency

**Legacy Alternative:**

Simple `POST /rest/v1/project_locales` is still available but not recommended for production use due to lack of verification and weaker error handling. See [4.2-locales-add-legacy.md](./4.2-locales-add-legacy.md) for details.
