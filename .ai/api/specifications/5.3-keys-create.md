# 5.3 Create Key with Default Value

**Endpoint:** `POST /rest/v1/rpc/create_key_with_value`  
**Description:** Create key in default language with initial value. **Triggers fan-out to all locales.**  
**Authentication:** Required

**Request Body:**

```json
{
  "p_default_value": "Welcome Home",
  "p_full_key": "app.home.title",
  "p_project_id": "uuid"
}
```

**Raw RPC Response (200 OK):**

The RPC function returns `TABLE(key_id uuid)` format. PostgREST automatically wraps TABLE results in an array:

```json
[
  {
    "key_id": "uuid"
  }
]
```

**Hook Response:**

The client hook uses `.single()` to extract the single object from the array:

```json
{
  "key_id": "uuid"
}
```

**Error Responses:**

**400 Bad Request (Invalid full_key format):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "regex",
      "field": "p_full_key"
    },
    "message": "Key can only contain lowercase letters, numbers, dots, underscores, and hyphens"
  }
}
```

**400 Bad Request (Consecutive dots in key):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "custom",
      "field": "p_full_key"
    },
    "message": "Key cannot contain consecutive dots"
  }
}
```

**400 Bad Request (Key ends with dot):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "custom",
      "field": "p_full_key"
    },
    "message": "Key cannot end with a dot"
  }
}
```

**400 Bad Request (Key too long):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "max",
      "field": "p_full_key"
    },
    "message": "Key name must be at most 256 characters"
  }
}
```

**400 Bad Request (Prefix mismatch):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "field": "p_full_key"
    },
    "message": "Key must start with project prefix"
  }
}
```

**400 Bad Request (Empty default value):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "min",
      "field": "p_default_value"
    },
    "message": "Value cannot be empty"
  }
}
```

**400 Bad Request (Value too long):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "max",
      "field": "p_default_value"
    },
    "message": "Value must be at most 250 characters"
  }
}
```

**400 Bad Request (Value contains newlines):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "custom",
      "field": "p_default_value"
    },
    "message": "Value cannot contain newlines"
  }
}
```

**400 Bad Request (Invalid project ID):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "uuid",
      "field": "p_project_id"
    },
    "message": "Invalid project ID format"
  }
}
```

**401 Unauthorized:**

```json
{
  "data": null,
  "error": {
    "code": 401,
    "message": "Authentication required"
  }
}
```

**403 Forbidden:**

```json
{
  "data": null,
  "error": {
    "code": 403,
    "message": "Project not found or access denied"
  }
}
```

**409 Conflict:**

```json
{
  "data": null,
  "error": {
    "code": 409,
    "details": {
      "constraint": "keys_unique_per_project"
    },
    "message": "Key already exists in project"
  }
}
```

**500 Internal Server Error:**

```json
{
  "data": null,
  "error": {
    "code": 500,
    "details": {
      "original": "error"
    },
    "message": "Failed to create key"
  }
}
```

**Validation:**

- `full_key`: required, max 256 chars, `[a-z0-9._-]`, no spaces, no `..`, no trailing dot
- Must start with project's `prefix` + `.`
- `default_value`: required (not empty), max 250 chars, no newline. Empty strings are auto-converted to NULL but not allowed for default locale.
- Trigger `validate_key_prefix_insert_trigger` enforces prefix requirement
- Trigger `trim_translation_value_insert_trigger` auto-trims and converts empty to NULL
- Trigger `validate_translation_default_locale_insert_trigger` prevents NULL/empty for default locale

**Business Logic:**

- Function `create_key_with_value()` atomically:
  1. Inserts into `keys` table
  2. Inserts default locale translation with `updated_by_user_id = auth.uid()`
  3. Trigger `fanout_translation_key_insert_trigger` creates NULL translations for all other locales
- Emit `key_created` telemetry event
