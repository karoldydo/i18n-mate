# 5.3 Create Key with Default Value

**Endpoint:** `POST /rest/v1/rpc/create_key_with_value`  
**Description:** Create key in default language with initial value. **Triggers fan-out to all locales.**  
**Authentication:** Required

**Request Body:**

```json
{
  "p_default_value": "Welcome Home",
  "p_full_key": "app.home.title",
  "p_project_id": "uuid"
}
```

**Raw RPC Response (200 OK):**

The RPC function returns `TABLE(key_id uuid)` format. PostgREST automatically wraps TABLE results in an array:

```json
[
  {
    "key_id": "uuid"
  }
]
```

**Hook Response:**

The client hook uses `.single()` to extract the single object from the array:

```json
{
  "key_id": "uuid"
}
```

**Implementation Note:**

```typescript
// Raw Supabase call returns array
const { data, error } = await supabase.rpc('create_key_with_value', params);
// data = [{ key_id: "uuid" }]

// Hook uses .single() to extract single object
const { data, error } = await supabase.rpc('create_key_with_value', params).single();
// data = { key_id: "uuid" }
```

**Error Responses:**

| Status Code                 | Condition                     | Message                                                                           | Details                                              |
| --------------------------- | ----------------------------- | --------------------------------------------------------------------------------- | ---------------------------------------------------- |
| `400 Bad Request`           | Invalid `full_key` format     | "Key can only contain lowercase letters, numbers, dots, underscores, and hyphens" | `{ field: "p_full_key", constraint: "regex" }`       |
| `400 Bad Request`           | Consecutive dots in key       | "Key cannot contain consecutive dots"                                             | `{ field: "p_full_key", constraint: "custom" }`      |
| `400 Bad Request`           | Key ends with dot             | "Key cannot end with a dot"                                                       | `{ field: "p_full_key", constraint: "custom" }`      |
| `400 Bad Request`           | Key too long                  | "Key name must be at most 256 characters"                                         | `{ field: "p_full_key", constraint: "max" }`         |
| `400 Bad Request`           | Prefix mismatch               | "Key must start with project prefix"                                              | `{ field: "p_full_key" }`                            |
| `400 Bad Request`           | Empty default value           | "Value cannot be empty"                                                           | `{ field: "p_default_value", constraint: "min" }`    |
| `400 Bad Request`           | Value too long                | "Value must be at most 250 characters"                                            | `{ field: "p_default_value", constraint: "max" }`    |
| `400 Bad Request`           | Value contains newlines       | "Value cannot contain newlines"                                                   | `{ field: "p_default_value", constraint: "custom" }` |
| `400 Bad Request`           | Invalid project ID            | "Invalid project ID format"                                                       | `{ field: "p_project_id", constraint: "uuid" }`      |
| `401 Unauthorized`          | Missing or invalid auth token | "Authentication required"                                                         | -                                                    |
| `403 Forbidden`             | Project not owned by user     | "Project not found or access denied"                                              | -                                                    |
| `409 Conflict`              | Key already exists            | "Key already exists in project"                                                   | `{ constraint: "keys_unique_per_project" }`          |
| `500 Internal Server Error` | Database/trigger error        | "Failed to create key"                                                            | `{ original: error }`                                |

**Example Error Response:**

```json
{
  "data": null,
  "error": {
    "code": 409,
    "details": {
      "constraint": "keys_unique_per_project"
    },
    "message": "Key already exists in project"
  }
}
```

**Validation:**

- `full_key`: required, max 256 chars, `[a-z0-9._-]`, no spaces, no `..`, no trailing dot
- Must start with project's `prefix` + `.`
- `default_value`: required (not empty), max 250 chars, no newline. Empty strings are auto-converted to NULL but not allowed for default locale.
- Trigger `validate_key_prefix_insert_trigger` enforces prefix requirement
- Trigger `trim_translation_value_insert_trigger` auto-trims and converts empty to NULL
- Trigger `validate_translation_default_locale_insert_trigger` prevents NULL/empty for default locale

**Business Logic:**

- Function `create_key_with_value()` atomically:
  1. Inserts into `keys` table
  2. Inserts default locale translation with `updated_by_user_id = auth.uid()`
  3. Trigger `fanout_translation_key_insert_trigger` creates NULL translations for all other locales
- Emit `key_created` telemetry event
