# 6.1 Update Translation (Inline Edit)

**Endpoint:** `PATCH /rest/v1/translations?project_id=eq.{project_id}&key_id=eq.{key_id}&locale=eq.{locale}`  
**Description:** Update translation value (autosave). **Updates metadata.**  
**Authentication:** Required

**Request Body:**

```json
{
  "is_machine_translated": false,
  "updated_by_user_id": "uuid",
  "updated_source": "user",
  "value": "Witaj w domu"
}
```

**Success Response (200 OK):**

```json
{
  "is_machine_translated": false,
  "key_id": "uuid",
  "locale": "pl",
  "project_id": "uuid",
  "updated_at": "2025-01-15T11:00:00Z",
  "updated_by_user_id": "uuid",
  "updated_source": "user",
  "value": "Witaj w domu"
}
```

**Error Responses:**

**400 Bad Request (Empty value for default locale):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "min",
      "field": "value"
    },
    "message": "Value cannot be empty for default locale"
  }
}
```

**400 Bad Request (Value contains newlines):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "custom",
      "field": "value"
    },
    "message": "Value cannot contain newlines"
  }
}
```

**400 Bad Request (Value too long):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "max",
      "field": "value"
    },
    "message": "Value must be at most 250 characters"
  }
}
```

**401 Unauthorized:**

```json
{
  "data": null,
  "error": {
    "code": 401,
    "message": "Authentication required"
  }
}
```

**403 Forbidden:**

```json
{
  "data": null,
  "error": {
    "code": 403,
    "message": "Project not owned by user"
  }
}
```

**404 Not Found:**

```json
{
  "data": null,
  "error": {
    "code": 404,
    "message": "Translation not found"
  }
}
```

**409 Conflict:**

```json
{
  "data": null,
  "error": {
    "code": 409,
    "message": "Translation was modified by another user. Please refresh and try again."
  }
}
```

**Validation:**

- `value`: max 250 chars, no newline, empty converted to NULL (except default locale)
- For default locale: value cannot be NULL or empty (trigger enforces)
- Trigger `trim_translation_value_insert_trigger` auto-trims whitespace
- Trigger `validate_translation_default_locale_insert_trigger` prevents NULL for default locale

**Optimistic Locking (Recommended):**

Include `updated_at` in WHERE clause to prevent lost updates when multiple users edit the same translation concurrently.

**Implementation Details:**

1. **Client obtains current timestamp** from previous GET request or update response
2. **Include timestamp in update URL** as query parameter:

   ```http
   PATCH /rest/v1/translations?project_id=eq.{project_id}&key_id=eq.{key_id}&locale=eq.{locale}&updated_at=eq.{timestamp}
   ```

3. **Server behavior:**
   - If `updated_at` matches current database value → update proceeds
   - If `updated_at` doesn't match (record was modified) → 0 rows affected → return 409 Conflict
   - If `updated_at` parameter omitted → update always proceeds (no optimistic locking)

4. **Client response handling:**
   - **200 OK**: Update successful, use returned data with new `updated_at`
   - **409 Conflict**: Record was modified by another user
     - Must refetch current data with GET request
     - Show conflict resolution UI to user
     - Retry update with new `updated_at` timestamp

**Example Conflict Resolution Flow:**

```javascript
// 1. User starts editing with timestamp from previous GET
const originalTimestamp = "2025-01-15T10:20:00Z";

// 2. User submits update
PATCH /rest/v1/translations?...&updated_at=eq.2025-01-15T10:20:00Z

// 3. Another user modified the record → 409 Conflict response
{
  "data": null,
  "error": {
    "code": 409,
    "message": "Translation was modified by another user. Please refresh and try again."
  }
}

// 4. Client refetches current data
GET /rest/v1/translations?project_id=eq.{project_id}&key_id=eq.{key_id}&locale=eq.{locale}

// 5. Show conflict resolution UI with both versions
// 6. User resolves conflict and retries with new timestamp
```

**Timestamp Format:**

- Must be valid ISO 8601 format: `YYYY-MM-DDTHH:mm:ssZ`
- Timezone must be UTC (Z suffix required)
- Precision: seconds level (no milliseconds)

**When to Use Optimistic Locking:**

- **Recommended for**: Manual user edits in UI (inline editing, forms)
- **Not recommended for**: Bulk operations, system-generated updates
- **Required for**: Production environments with multiple concurrent users
