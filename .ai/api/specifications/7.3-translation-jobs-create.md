# 7.3 Create Translation Job

**Endpoint:** `POST /functions/v1/translate`  
**Description:** Create and execute LLM translation job (Supabase Edge Function)  
**Authentication:** Required

**Request Body:**

```json
{
  "key_ids": [],
  "mode": "all",
  "params": {
    "max_tokens": 256,
    "temperature": 0.3
  },
  "project_id": "uuid",
  "target_locale": "pl"
}
```

**Mode Options:**

- `"all"` - Translate all keys (empty `key_ids` array)
- `"selected"` - Translate specific keys (`key_ids` array populated)
- `"single"` - Translate single key (`key_ids` array with one element)

**Success Response (202 Accepted):**

```json
{
  "job_id": "uuid",
  "message": "Translation job created",
  "status": "pending"
}
```

**Error Responses:**

**400 Bad Request (Invalid target locale):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "exists",
      "field": "target_locale"
    },
    "message": "Target locale does not exist in project"
  }
}
```

**400 Bad Request (Target locale is default):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "custom",
      "field": "target_locale"
    },
    "message": "Target locale cannot be the default locale"
  }
}
```

**400 Bad Request (Invalid mode):**

```json
{
  "data": null,
  "error": {
    "code": 400,
    "details": {
      "constraint": "enum",
      "field": "mode"
    },
    "message": "Mode must be one of: all, selected, single"
  }
}
```

**401 Unauthorized:**

```json
{
  "data": null,
  "error": {
    "code": 401,
    "message": "Authentication required"
  }
}
```

**403 Forbidden:**

```json
{
  "data": null,
  "error": {
    "code": 403,
    "message": "Project not owned by user"
  }
}
```

**409 Conflict:**

```json
{
  "data": null,
  "error": {
    "code": 409,
    "message": "Another translation job is already active for this project"
  }
}
```

**Validation:**

- `target_locale`: required, must exist in project's locales, **cannot be default locale**
- `mode`: required, one of `all`, `selected`, `single`
- `key_ids`: required for `selected` and `single` modes
- Trigger `validate_source_locale_is_default_trigger` enforces source = default locale
- Trigger `prevent_multiple_active_jobs_trigger` enforces one active job per project

**Business Logic (Edge Function):**

1. Validate request and check for active jobs
2. Create `translation_jobs` record with `status = 'pending'`
3. Create `translation_job_items` records for each key
4. Fetch source (default locale) values for selected keys
5. For each key:
   - Call OpenRouter API with context and LLM params
   - Parse response and validate (max 250 chars, no newline)
   - Update corresponding `translations` record with:
     - `value = <translated_text>`
     - `is_machine_translated = true`
     - `updated_source = 'system'`
     - `updated_by_user_id = NULL`
   - Update `translation_job_items` status (completed/failed)
   - Update job counters: `completed_keys`, `failed_keys`
6. Update job status to `completed` or `failed`
7. Emit `translation_completed` telemetry event
8. Return job summary

**Frontend Polling:**
After receiving 202 response, client polls `GET /rest/v1/translation_jobs?id=eq.{job_id}` every 2 seconds until `status IN ('completed', 'failed', 'cancelled')`.
