# 5.2 List Keys (Per-Language View)

**Endpoint:** `GET /rest/v1/rpc/list_keys_per_language_view`  
**Description:** List keys with values for selected locale. Supports search and missing filter.  
**Authentication:** Required

**Query Parameters:**

- `project_id` - Project UUID (required)
- `locale` - Target locale code (required, BCP-47 format)
- `search` - Search term for key name (optional). If omitted or empty, no search filter is applied.
- `missing_only` - Filter keys with NULL values in selected locale (optional, boolean). Default: `false`. `undefined` is treated as `false`. Note: Empty strings are auto-converted to NULL.
- `limit` - Items per page (optional, integer). Default: `50`, max: `100`, min: `1`.
- `offset` - Pagination offset (optional, integer). Default: `0`, min: `0`.

**Parameter Behavior Notes:**
- Optional boolean parameters: `undefined` = `false`, omitted = `false`
- Optional string parameters: `undefined` = no filter applied, empty string = no filter applied
- Optional integer parameters: use documented defaults when omitted

**Example Request:**

```
GET /rest/v1/rpc/list_keys_per_language_view?project_id={uuid}&locale=pl&missing_only=true&limit=50&offset=0
```

**Raw RPC Response (200 OK):**

PostgREST returns a plain JSON array:

```json
[
  {
    "full_key": "app.home.title",
    "is_machine_translated": false,
    "key_id": "uuid",
    "updated_at": "2025-01-15T10:05:00Z",
    "updated_by_user_id": null,
    "updated_source": "user",
    "value": null
  },
  {
    "full_key": "app.home.cta",
    "is_machine_translated": true,
    "key_id": "uuid",
    "updated_at": "2025-01-15T10:20:00Z",
    "updated_by_user_id": null,
    "updated_source": "system",
    "value": "Rozpocznij teraz"
  }
]
```

**Hook Response:**

The client hook wraps the result with pagination metadata:

```json
{
  "data": [
    {
      "full_key": "app.home.title",
      "is_machine_translated": false,
      "key_id": "uuid",
      "updated_at": "2025-01-15T10:05:00Z",
      "updated_by_user_id": null,
      "updated_source": "user",
      "value": null
    },
    {
      "full_key": "app.home.cta",
      "is_machine_translated": true,
      "key_id": "uuid",
      "updated_at": "2025-01-15T10:20:00Z",
      "updated_by_user_id": null,
      "updated_source": "system",
      "value": "Rozpocznij teraz"
    }
  ],
  "metadata": {
    "end": 1,
    "start": 0,
    "total": 2
  }
}
```

**Error Responses:**

| Status Code | Condition | Message | Details |
|-------------|-----------|---------|---------|
| `400 Bad Request` | Missing `locale` parameter | "Locale parameter is required" | `{ field: "locale", constraint: "required" }` |
| `400 Bad Request` | Invalid locale format | "Locale must be in BCP-47 format (e.g., \"en\" or \"en-US\")" | `{ field: "locale", constraint: "regex" }` |
| `400 Bad Request` | Invalid UUID format for `project_id` | "Invalid project ID format" | `{ field: "project_id", constraint: "uuid" }` |
| `400 Bad Request` | Invalid pagination params | "Limit must be between 1 and 100" | `{ field: "limit", constraint: "max" }` |
| `401 Unauthorized` | Missing or invalid auth token | "Authentication required" | - |
| `403 Forbidden` | Project not owned by user or locale doesn't exist | "Project not found, access denied, or locale does not exist in project" | - |
| `500 Internal Server Error` | Database connection/RPC error | "Failed to fetch keys" | `{ original: error }` |

**Example Error Response:**
```json
{
  "data": null,
  "error": {
    "code": 400,
    "message": "Locale must be in BCP-47 format (e.g., \"en\" or \"en-US\")",
    "details": {
      "field": "locale",
      "constraint": "regex"
    }
  }
}
```

**Business Logic:**

- Uses `idx_translations_missing` for efficient missing filter
- Metadata fields show translation provenance (manual vs LLM)

**Notes:**

- **Response Structure:**
  - The RPC function returns a plain JSON array of rows
  - Supabase provides total count via the `count: 'exact'` option
  - Client hooks transform the array into `{ data, metadata }` format
  - `metadata` is built from Supabase's `count`, request `offset`, and array length

- **Field Semantics:**
  - `value` can be `null` when translation is missing (empty strings are auto-converted to NULL by `trim_translation_value_trigger`)
  - `updated_by_user_id` can be `null` for system updates (LLM translations)
  - `updated_source` is enum: `"user"` (manual edit) | `"system"` (LLM translation)
  - `is_machine_translated`: `true` = LLM-generated, `false` = manually edited
  - `updated_at`: Auto-updated by database trigger on any value change
